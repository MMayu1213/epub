# PDF Kindle Optimizer - AI実行ガイド

## プロジェクト概要
このプロジェクトは、縦書きPDFの余白を自動検出・除去し、Kindle端末で見やすく最適化するツールです。
**左右ページで異なる余白設定に対応しています。**

## フォルダ構成
```
input/   - PDFファイルを配置する場所
output/  - 処理済みファイルの出力先
preview/ - プレビュー画像の出力先
```

## AI向け実行フロー

### セットアップ確認
まず依存関係がインストールされているか確認してください：
```bash
pip install -e .
```

### ワークフロー1: AI支援クロップ（推奨）

ユーザーがPDFの余白を除去したい場合は、以下のステップで進めてください：

**ステップ1: PDFファイルの確認**
```bash
ls input/
```
inputフォルダにPDFがあるか確認します。

**ステップ2: 開き方を指定してプレビュー画像を生成**
```bash
# 縦開き（右綴じ）の場合（日本語書籍のデフォルト）
pdf-kindle preview input/[ファイル名].pdf --binding vertical

# 横開き（左綴じ）の場合
pdf-kindle preview input/[ファイル名].pdf --binding horizontal
```
これにより `preview/` フォルダにサンプルページの画像が出力されます。
**各ページに「右ページ」「左ページ」の情報が表示されます。**

**ステップ3: 画像を一枚ずつ確認してクロップ位置を判断**

> **【重要】画像は一枚ずつ表示して処理してください。複数画像を同時表示するとAPI errorの原因になります。**

出力された画像を確認し、左右ページそれぞれの余白をどれだけ除去すべきか%で判断してください。

**左ページ:**
- 左からX%（ページ外側、余白が大きい傾向）
- 右からY%（綴じ側、余白が小さい傾向）
- 上からZ%
- 下からW%

**右ページ:**
- 左からA%（綴じ側、余白が小さい傾向）
- 右からB%（ページ外側、余白が大きい傾向）
- 上からC%
- 下からD%

**ヒント: Kindleデバイスのアスペクト比（約0.75）を考慮してクロップ位置を決定してください。**
- コンテンツ領域が縦長すぎる場合（比率 < 0.75）→ 上下を多めにカット
- コンテンツ領域が横長すぎる場合（比率 > 0.75）→ 左右を多めにカット
- 理想的にはクロップ後のアスペクト比が0.70〜0.80になるよう調整

**ステップ4: 左右ページ別にクロップを実行**
```bash
# 左右ページ別設定（縦開きの場合）
pdf-kindle crop input/[ファイル名].pdf --binding vertical \
  --left-left 15 --left-right 5 --left-top 5 --left-bottom 5 \
  --right-left 5 --right-right 15 --right-top 5 --right-bottom 5

# 全ページ共通設定（従来の方法）
pdf-kindle crop input/[ファイル名].pdf --left [X] --right [Y] --top [Z] --bottom [W]
```

出力は `output/[ファイル名]_kindle.pdf` に保存されます。

### ワークフロー2: 自動検出クロップ

AIによる画像判断なしで、テキスト位置から自動検出する場合：

**単一ファイル処理:**
```bash
pdf-kindle auto input/[ファイル名].pdf
```

**inputフォルダ全体を一括処理:**
```bash
pdf-kindle auto
```

### ワークフロー3: スキャンPDF（画像ベースPDF）

スキャンされたPDF（テキストが埋め込まれていない画像PDF）の場合：
```bash
pdf-kindle auto --scan --auto-threshold -m 0 input/[ファイル名].pdf
```

## コマンドオプション早見表

### previewコマンド
| オプション | 説明 | 例 |
|-----------|------|-----|
| `-p, --pages` | 出力ページ指定 | `-p 1,10,50` |
| `-n, --num-pages` | ランダム選択数 | `-n 10` |
| `--dpi` | 解像度 | `--dpi 300` |
| `--binding` | 開き方 | `--binding vertical` |

### cropコマンド
| オプション | 説明 | 例 |
|-----------|------|-----|
| `--left` | 左からカット(%)-全ページ共通 | `--left 10` |
| `--right` | 右からカット(%)-全ページ共通 | `--right 15` |
| `--top` | 上からカット(%)-全ページ共通 | `--top 5` |
| `--bottom` | 下からカット(%)-全ページ共通 | `--bottom 5` |
| `--binding` | 開き方 | `--binding vertical` |
| `--left-left` | 左ページの左からカット(%) | `--left-left 15` |
| `--left-right` | 左ページの右からカット(%) | `--left-right 5` |
| `--right-left` | 右ページの左からカット(%) | `--right-left 5` |
| `--right-right` | 右ページの右からカット(%) | `--right-right 15` |
| `-d, --device` | Kindleデバイス | `-d paperwhite` |

### autoコマンド
| オプション | 説明 | 例 |
|-----------|------|-----|
| `--scan` | スキャンPDFモード | `--scan` |
| `--auto-threshold` | Otsu法自動閾値 | `--auto-threshold` |
| `-t, --threshold` | 二値化閾値 | `-t 230` |
| `-m, --margin` | 追加マージン | `-m 0.02` |

## 対応Kindleデバイス

| デバイス | 解像度 | アスペクト比 |
|----------|--------|--------------|
| `paperwhite` (デフォルト) | 1236 x 1648 | 約 0.75 |
| `oasis` | 1264 x 1680 | 約 0.75 |
| `basic` | 1072 x 1448 | 約 0.74 |
| `scribe` | 1860 x 2480 | 約 0.75 |

**注意**: クロップ後のコンテンツがKindle画面を最大限活用できるよう、アスペクト比を考慮してクロップ位置を決定してください。

## トラブルシューティング

### 「コマンドが見つからない」エラー
```bash
pip install -e .
```
を実行してツールをインストールしてください。

### 余白が残る場合
`--margin` を減らすか、手動で `crop` コマンドを使用してください。

### 文字が切れる場合
`--margin` を増やしてください（例: `-m 0.05`）

### スキャンPDFで検出がうまくいかない場合
`--threshold` 値を調整してください（デフォルト: 250）
- 文字が薄い: `-t 230`
- 余白が残る: `-t 252`
