# PDF Kindle Optimizer スキル

このスキルは、PDF Kindle Optimizerツールを使ってPDFの余白を除去し、Kindle端末向けに最適化する作業をAIが支援するためのものです。

## スキルが適用される条件

ユーザーが以下のような依頼をした場合にこのスキルを使用してください：
- 「PDFの余白を除去したい」
- 「PDFをKindle用に最適化したい」
- 「このPDFを見やすくしたい」
- 「縦書きPDFの余白をカットして」
- 「スキャンPDFの余白を削除」
- inputフォルダにあるPDFについて言及された場合

## 実行前の準備

### 1. ツールのインストール確認
```bash
pip install -e .
```
このコマンドでツールをインストールしてください。すでにインストール済みの場合はスキップ可能です。

### 2. inputフォルダの確認
```bash
ls input/
```
PDFファイルがあるか確認してください。

## ワークフロー選択ガイド

ユーザーの状況に応じて適切なワークフローを提案してください：

| 状況 | 推奨ワークフロー |
|------|------------------|
| 最初の処理 / 最高品質を求める | AI支援クロップ（ワークフロー1） |
| 複数ファイルを一括処理したい | 自動検出（ワークフロー2） |
| スキャンされたPDF（画像のみ） | スキャンPDF処理（ワークフロー3） |
| クロップ位置がすでにわかっている | 直接cropコマンド |

---

## ワークフロー1: AI支援クロップ（推奨）

最も正確な結果が得られるワークフローです。AIが画像を見てクロップ位置を判断します。

### ステップ1: プレビュー画像を生成

```bash
pdf-kindle preview input/[ファイル名].pdf
```

**オプション:**
- 特定ページを指定: `-p 1,10,50`
- ページ数を増やす: `-n 10`
- 高解像度: `--dpi 300`

### ステップ2: 画像を確認

`preview/`フォルダに出力された画像を確認してください。`read_file`ツールで画像を読み込んで分析できます。

**分析のポイント:**
- 左右の余白の幅を%で見積もる
- 上下の余白の幅を%で見積もる
- ページ番号や柱（ヘッダー）を残すか除去するか確認

### ステップ3: クロップ位置を決定（Kindleサイズを考慮）

画像を分析し、以下の形式でクロップ位置を決定してください：
- 左から: X%
- 右から: Y%
- 上から: Z%
- 下から: W%

**重要: Kindleデバイスのアスペクト比を考慮してクロップ位置を決定してください。**

| デバイス | 解像度 | アスペクト比 |
|----------|--------|--------------|
| `paperwhite` | 1236 x 1648 | 約 3:4 (0.75) |
| `oasis` | 1264 x 1680 | 約 3:4 (0.75) |
| `basic` | 1072 x 1448 | 約 3:4 (0.74) |
| `scribe` | 1860 x 2480 | 約 3:4 (0.75) |

**クロップ位置決定の考え方：**

1. **コンテンツ領域のアスペクト比を計算**
   - 画像からコンテンツ（文字・図）がある領域を特定
   - その領域のアスペクト比（幅÷高さ）を計算

2. **Kindleアスペクト比（約0.75）に近づける**
   - コンテンツ領域が縦長すぎる場合（比率 < 0.75）→ 上下を多めにカット
   - コンテンツ領域が横長すぎる場合（比率 > 0.75）→ 左右を多めにカット
   - 理想的には、クロップ後のアスペクト比が0.70〜0.80になるよう調整

3. **Kindle画面を最大限活用する**
   - 余白を除去してコンテンツを画面いっぱいに表示
   - ただし、文字が切れないよう最小限のマージン（1-2%）は確保

**計算例：**
- 元のPDFページ: 595 x 842 pt（A4、比率0.71）
- コンテンツ領域: 中央の400 x 700 pt（比率0.57、縦長すぎる）
- 調整: 上下のクロップを増やして比率を0.75に近づける

**典型的な値の目安:**
- 縦書き書籍: 左右10-15%、上下5-10%
- 論文・レポート: 左右8-12%、上下5-8%
- マンガ: 左右3-5%、上下2-3%（画像ギリギリ）
- **Kindle最適化重視**: アスペクト比0.75を目指して調整

### ステップ4: クロップを実行

```bash
pdf-kindle crop input/[ファイル名].pdf --left [X] --right [Y] --top [Z] --bottom [W]
```

**例:**
```bash
pdf-kindle crop input/book.pdf --left 12 --right 10 --top 5 --bottom 5
```

出力先: `output/[ファイル名]_kindle.pdf`

---

## ワークフロー2: 自動検出クロップ

テキスト位置を自動検出してクロップします。手軽ですがAI支援より精度が劣る場合があります。

### 単一ファイル処理
```bash
pdf-kindle auto input/[ファイル名].pdf
```

### 一括処理（inputフォルダ全体）
```bash
pdf-kindle auto
```

### オプション調整

**余白が残る場合:**
```bash
pdf-kindle auto input/book.pdf -m 0
```

**文字が切れる場合:**
```bash
pdf-kindle auto input/book.pdf -m 0.05
```

---

## ワークフロー3: スキャンPDF処理

スキャンされたPDF（テキストが埋め込まれていない画像PDF）の場合に使用します。

### 基本コマンド
```bash
pdf-kindle auto --scan --auto-threshold -m 0 input/[ファイル名].pdf
```

### 検出がうまくいかない場合

**文字が薄いPDF:**
```bash
pdf-kindle auto --scan -t 230 -m 0 input/[ファイル名].pdf
```

**余白が残る場合:**
```bash
pdf-kindle auto --scan -t 252 -m 0 input/[ファイル名].pdf
```

---

## Kindleデバイス指定

出力サイズをKindleデバイスに合わせる場合は `-d` オプションを使用：

```bash
pdf-kindle crop input/book.pdf --left 10 --right 10 -d oasis
```

| デバイス | 解像度 |
|----------|--------|
| `paperwhite` (デフォルト) | 1236 x 1648 |
| `oasis` | 1264 x 1680 |
| `basic` | 1072 x 1448 |
| `scribe` | 1860 x 2480 |

---

## トラブルシューティング

### 「コマンドが見つからない」エラー
```bash
pip install -e .
```
を実行してください。

### 処理結果の確認
出力されたPDFは `output/` フォルダに保存されます。プレビューで確認する場合：
```bash
pdf-kindle preview output/[ファイル名]_kindle.pdf
```

### 再処理する場合
パラメータを調整して再度実行してください。既存の出力ファイルは上書きされます。

---

## ユーザーへの対話例

**ユーザーが「PDFの余白を除去したい」と言った場合:**

1. inputフォルダを確認
2. PDFファイルがあれば、プレビュー画像を生成して確認
3. **Kindleのアスペクト比（0.75）を考慮してクロップ位置を計算・提案**
4. ユーザーの確認後、クロップを実行

**ユーザーが「自動で処理して」と言った場合:**

`pdf-kindle auto` コマンドで自動処理を実行し、結果を報告してください。

**ユーザーが特定のKindleデバイスを持っている場合:**

1. 該当デバイスのサイズを確認（例: Scribeなら1860x2480）
2. そのアスペクト比に最適化されるようクロップ位置を調整
3. `-d [デバイス名]` オプションを使用してコマンドを実行
